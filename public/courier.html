<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´¾é€å“¡çµ‚ç«¯</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>canvas { border: 2px dashed #999; background: #fff; width: 100%; height: 250px; border-radius: 8px; }</style>
</head>
<body class="bg-dark text-white container py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">ğŸšš æ´¾é€å“¡ç³»çµ±</h4>
        <span id="displayId" class="badge bg-warning text-dark"></span>
    </div>

    <div class="card text-dark mb-3">
        <div class="card-body">
            <h5 class="card-title" id="recipientName">è¼‰å…¥ä¸­...</h5>
            <p class="card-text">ç›®å‰ç‹€æ…‹ï¼š<span id="currentStatus" class="fw-bold text-danger">--</span></p>
        </div>
    </div>

    <div id="menuMode">
        <button onclick="showUpdate()" class="btn btn-outline-light w-100 py-3 mb-3 fw-bold">ğŸ“ æ›´æ–°ç‰©æµä½ç½®</button>
        <button onclick="showSign()" class="btn btn-danger w-100 py-3 fw-bold">âœï¸ å®¢æˆ¶ç°½æ”¶</button>
        <a href="/index.html" class="btn btn-link text-white-50 w-100 mt-2">å›é¦–é </a>
    </div>

    <div id="updateMode" class="d-none">
        <h5 class="mb-3">æ›´æ–°åŒ…è£¹ç‹€æ…‹</h5>
        <select id="newStatus" class="form-select mb-3">
            <option value="é‹è¼¸ä¸­">ğŸš› é‹è¼¸ä¸­</option>
            <option value="æ´¾é€ä¸­">ğŸƒ æ´¾é€ä¸­ (å³å°‡æŠµé”)</option>
            <option value="æŠµé”é–€å£">ğŸšª å·²æŠµé”é–€å£/å®¢å»³</option>
            <option value="å¡ä½äº†">âš ï¸ å¡ä½äº† (è£½é€ æ‡¸å¿µ)</option>
        </select>
        <input type="text" id="newLocation" class="form-control mb-3" placeholder="è¼¸å…¥ç›®å‰ä½ç½® (ä¾‹: æ²™ç™¼è½‰é‹ç«™)">
        <button onclick="submitUpdate()" class="btn btn-primary w-100 mb-2">ç¢ºèªæ›´æ–°</button>
        <button onclick="resetView()" class="btn btn-secondary w-100">å–æ¶ˆ</button>
    </div>

    <div id="signMode" class="d-none">
        <h5 class="mb-2 text-center">è«‹åœ¨æ­¤è™•ç°½å</h5>
        <canvas id="signature-pad"></canvas>
        <div class="d-flex gap-2 mt-2">
            <button onclick="clearPad()" class="btn btn-secondary flex-grow-1">é‡å¯«</button>
            <button onclick="submitSign()" class="btn btn-danger flex-grow-1">ç¢ºèªç°½æ”¶</button>
        </div>
        <button onclick="resetView()" class="btn btn-link text-white-50 w-100 mt-2">å–æ¶ˆ</button>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        document.getElementById('displayId').innerText = id || 'ç„¡å–®è™Ÿ';

        // ç°½åæ¿è¨­å®š
        const canvas = document.getElementById('signature-pad');
        const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgba(255, 255, 255, 0)' });
        
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }
        window.addEventListener("resize", resizeCanvas);

        // è®€å–è³‡æ–™
        if(id) {
            fetch(`/api/track?id=${id}`).then(res => res.json()).then(data => {
                if(data.error) {
                    alert(data.error);
                } else {
                    document.getElementById('recipientName').innerText = `æ”¶ä»¶äººï¼š${data.recipient}`;
                    document.getElementById('currentStatus').innerText = data.status;
                }
            });
        } else {
            alert("ç¶²å€ç¼ºå°‘ ID åƒæ•¸");
        }

        function showUpdate() { toggle('menuMode', 'updateMode'); }
        function showSign() { toggle('menuMode', 'signMode'); setTimeout(resizeCanvas, 100); } // å»¶é²ç¢ºä¿æ¸²æŸ“æ­£ç¢º
        function resetView() { 
            document.getElementById('menuMode').classList.remove('d-none');
            document.getElementById('updateMode').classList.add('d-none');
            document.getElementById('signMode').classList.add('d-none');
        }
        function toggle(hide, show) {
            document.getElementById(hide).classList.add('d-none');
            document.getElementById(show).classList.remove('d-none');
        }
        function clearPad() { signaturePad.clear(); }

        async function submitUpdate() {
            const status = document.getElementById('newStatus').value;
            const location = document.getElementById('newLocation').value;
            if(!location) return alert("è«‹è¼¸å…¥ä½ç½®");
            
            await fetch('/api/track', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'update', id, status, location })
            });
            alert('æ›´æ–°æˆåŠŸï¼');
            location.reload();
        }

        async function submitSign() {
            if (signaturePad.isEmpty()) return alert("è«‹å…ˆç°½å");
            const signature = signaturePad.toDataURL();
            
            await fetch('/api/track', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'sign', id, signature })
            });
            alert('ğŸ‰ ç°½æ”¶å®Œæˆï¼');
            window.location.href = `/index.html?id=${id}`;
        }
    </script>
</body>
</html>
